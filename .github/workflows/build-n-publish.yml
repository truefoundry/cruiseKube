name: Push image to JFROG Public

on:
  push:
    branches:
      - 'main'

permissions:
  id-token: write
  contents: read

jobs:
  build-operator:
    name: Build and Push Docker Images
    uses: truefoundry/github-workflows-public/.github/workflows/build.yml@main
    with:
      image_tag: ${{ github.sha }}
      image_artifact_name: 'cruisekube'
      dockerfile_path: 'Dockerfile'
      artifactory_registry_url: ${{ vars.TRUEFOUNDRY_ARTIFACTORY_REGISTRY_URL }}
      artifactory_repository_url: ${{ vars.TRUEFOUNDRY_ARTIFACTORY_PUBLIC_REPOSITORY }}
      platforms: 'linux/amd64'
    secrets:
      artifactory_username: ${{ secrets.TRUEFOUNDRY_ARTIFACTORY_PUBLIC_USERNAME }}
      artifactory_password: ${{ secrets.TRUEFOUNDRY_ARTIFACTORY_PUBLIC_PASSWORD }}
  
  # Build and push cruisekube-frontend image
  build-cruisekube-frontend:
    name: Build and Push cruisekube-frontend Docker Images
    runs-on: ubuntu-latest
    env:
      IMAGE_TAG: ${{ github.sha }}
      IMAGE_ARTIFACT_NAME: "cruisekube-frontend"
      DOCKERFILE_PATH: "cruiseKube-frontend/Dockerfile"
      IMAGE_CONTEXT: "cruiseKube-frontend"
      ARTIFACTORY_REGISTRY_URL: ${{ vars.TRUEFOUNDRY_ARTIFACTORY_REGISTRY_URL }}
      ARTIFACTORY_REPOSITORY_URL: ${{ vars.TRUEFOUNDRY_ARTIFACTORY_PUBLIC_REPOSITORY }}
      PLATFORMS: 'linux/amd64'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: "0"
          submodules: "recursive"
          token: ${{ secrets.CRUISE_KUBE_CI_SECRET }}

      - name: Validate registry configuration
        run: |
          if [ -z "$ARTIFACTORY_REGISTRY_URL" ] || [ -z "$ARTIFACTORY_REPOSITORY_URL" ]; then
            echo "Error: Artifactory registry or repository URL is not set"
            exit 1
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to JFrog Artifactory
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ARTIFACTORY_REGISTRY_URL }}
          username: ${{ secrets.TRUEFOUNDRY_ARTIFACTORY_PUBLIC_USERNAME }}
          password: ${{ secrets.TRUEFOUNDRY_ARTIFACTORY_PUBLIC_PASSWORD }}

      - name: Prepare image tags
        id: prepare_tags
        run: |
          FULL_IMAGE_NAME="${ARTIFACTORY_REPOSITORY_URL}/${IMAGE_ARTIFACT_NAME}"
          IMAGE_WITH_TAG="${FULL_IMAGE_NAME}:${IMAGE_TAG}"
          echo "image=${IMAGE_WITH_TAG}" >> $GITHUB_OUTPUT
          echo "image_name=${FULL_IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "Image: ${IMAGE_WITH_TAG}"

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.IMAGE_CONTEXT }}
          file: ${{ env.DOCKERFILE_PATH }}
          platforms: ${{ env.PLATFORMS }}
          push: true
          tags: ${{ steps.prepare_tags.outputs.image }}
          cache-from: type=registry,ref=${{ steps.prepare_tags.outputs.image_name }}:buildcache
          cache-to: type=registry,ref=${{ steps.prepare_tags.outputs.image_name }}:buildcache,mode=max

      - name: Output image digest
        run: |
          echo "Image digest for ${{ steps.prepare_tags.outputs.image }} has been pushed successfully"

  # We are updating the sha in the helm chart values.yaml file on the helm-main branch
  update-helm-chart:
    name: Update Helm values.yaml
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: [build-operator, build-cruisekube-frontend]
    steps:
      - name: Checkout helm-main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: "0"
          ref: helm-main
      - name: Fetch main branch
        run: git fetch origin main:main
      - name: Sync charts from main
        run: |
          # Removing charts directory and copying fresh from main
          git fetch origin main:main
          rm -rf charts/
          git checkout main -- charts/
      - name: Update Helm values.yaml
        run: |
          cd charts/cruisekube
          yq -i '.cruisekubeController.image.tag="${{ github.sha }}"' values.yaml
          yq -i '.cruisekubeWebhook.image.tag="${{ github.sha }}"' values.yaml
          yq -i '.cruisekubeFrontend.image.tag="${{ github.sha }}"' values.yaml
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git add -A
          git commit -m "Update Helm values.yaml on helm-main branch with sha: ${{ github.sha }}" --signoff
          git push --force origin helm-main
