name: Release cruisekube Helm Chart

on:
  push:
    tags:
      - v*

env:
  HELM_REGISTRY_URL: ${{ vars.TRUEFOUNDRY_ARTIFACTORY_REGISTRY_URL }}
  HELM_REGISTRY_USERNAME: ${{ secrets.TRUEFOUNDRY_ARTIFACTORY_PUBLIC_USERNAME }}
  HELM_REGISTRY_PASSWORD: ${{ secrets.TRUEFOUNDRY_ARTIFACTORY_PUBLIC_PASSWORD }}
  HELM_CHART_REPOSITORY: ${{ vars.TRUEFOUNDRY_ARTIFACTORY_PUBLIC_HELM_REPOSITORY }}

jobs:
  # Read chart values first
  read-chart-values:
    runs-on: ubuntu-latest
    outputs:
      chart_version: ${{ steps.read_chart.outputs.CHART_VERSION }}
      app_version: ${{ steps.read_chart.outputs.APP_VERSION }}
      chart_name: ${{ steps.read_chart.outputs.CHART_NAME }}
      cruisekube_tag: ${{ steps.read_chart.outputs.cruisekube_TAG }}
      cruisekube_frontend_tag: ${{ steps.read_chart.outputs.cruisekube_frontend_TAG }}
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: "0"
          submodules: "recursive"
          token: ${{ secrets.CRUISE_KUBE_CI_SECRET }}

      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      - name: Read chart values
        id: read_chart
        run: |
          CHART_VERSION=$(yq -r '.version' charts/cruisekube/Chart.yaml)
          echo "CHART_VERSION=$CHART_VERSION" >> $GITHUB_OUTPUT

          APP_VERSION=$(yq -r '.appVersion' charts/cruisekube/Chart.yaml)
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_OUTPUT

          CHART_NAME=$(yq -r '.name' charts/cruisekube/Chart.yaml)
          echo "CHART_NAME=$CHART_NAME" >> $GITHUB_OUTPUT

          cruisekube_TAG=$(yq -r '.cruisekubeController.image.tag' charts/cruisekube/values.yaml)
          echo "cruisekube_TAG=$cruisekube_TAG" >> $GITHUB_OUTPUT

          cruisekube_frontend_TAG=$(yq -r '.cruisekubeFrontend.image.tag' charts/cruisekube/values.yaml)
          echo "cruisekube_frontend_TAG=$cruisekube_frontend_TAG" >> $GITHUB_OUTPUT

          echo "Chart values read: $CHART_NAME v$CHART_VERSION (app v$APP_VERSION)"
          echo "cruisekube tag: $cruisekube_TAG"
          echo "cruisekube-frontend tag: $cruisekube_frontend_TAG"

  # Build and push cruisekube image
  build-cruisekube:
    name: Build and Push cruisekube Docker Images
    needs: [read-chart-values]
    uses: truefoundry/github-workflows-public/.github/workflows/build.yml@main
    with:
      image_tag: ${{ needs.read-chart-values.outputs.cruisekube_tag }}
      image_artifact_name: "cruisekube"
      dockerfile_path: "Dockerfile"
      artifactory_registry_url: ${{ vars.TRUEFOUNDRY_ARTIFACTORY_REGISTRY_URL }}
      artifactory_repository_url: ${{ vars.TRUEFOUNDRY_ARTIFACTORY_PUBLIC_REPOSITORY }}
      platforms: 'linux/amd64'
    secrets:
      artifactory_username: ${{ secrets.TRUEFOUNDRY_ARTIFACTORY_PUBLIC_USERNAME }}
      artifactory_password: ${{ secrets.TRUEFOUNDRY_ARTIFACTORY_PUBLIC_PASSWORD }}

  # Build and push cruisekube-frontend image
  build-cruisekube-frontend:
    name: Build and Push cruisekube-frontend Docker Images
    needs: [read-chart-values]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      IMAGE_TAG: ${{ needs.read-chart-values.outputs.cruisekube_frontend_tag }}
      IMAGE_ARTIFACT_NAME: "cruisekube-frontend"
      DOCKERFILE_PATH: "cruiseKube-frontend/Dockerfile"
      IMAGE_CONTEXT: "cruiseKube-frontend"
      ARTIFACTORY_REGISTRY_URL: ${{ vars.TRUEFOUNDRY_ARTIFACTORY_REGISTRY_URL }}
      ARTIFACTORY_REPOSITORY_URL: ${{ vars.TRUEFOUNDRY_ARTIFACTORY_PUBLIC_REPOSITORY }}
      PLATFORMS: 'linux/amd64'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: "0"
          submodules: "recursive"
          token: ${{ secrets.CRUISE_KUBE_CI_SECRET }}

      - name: Validate registry configuration
        run: |
          if [ -z "$ARTIFACTORY_REGISTRY_URL" ] || [ -z "$ARTIFACTORY_REPOSITORY_URL" ]; then
            echo "Error: Artifactory registry or repository URL is not set"
            exit 1
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to JFrog Artifactory
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ARTIFACTORY_REGISTRY_URL }}
          username: ${{ secrets.TRUEFOUNDRY_ARTIFACTORY_PUBLIC_USERNAME }}
          password: ${{ secrets.TRUEFOUNDRY_ARTIFACTORY_PUBLIC_PASSWORD }}

      - name: Prepare image tags
        id: prepare_tags
        run: |
          FULL_IMAGE_NAME="${ARTIFACTORY_REPOSITORY_URL}/${IMAGE_ARTIFACT_NAME}"
          IMAGE_WITH_TAG="${FULL_IMAGE_NAME}:${IMAGE_TAG}"
          echo "image=${IMAGE_WITH_TAG}" >> $GITHUB_OUTPUT
          echo "image_name=${FULL_IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "Image: ${IMAGE_WITH_TAG}"

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.IMAGE_CONTEXT }}
          file: ${{ env.DOCKERFILE_PATH }}
          platforms: ${{ env.PLATFORMS }}
          push: true
          tags: ${{ steps.prepare_tags.outputs.image }}
          cache-from: type=registry,ref=${{ steps.prepare_tags.outputs.image_name }}:buildcache
          cache-to: type=registry,ref=${{ steps.prepare_tags.outputs.image_name }}:buildcache,mode=max

      - name: Output image digest
        run: |
          echo "Image digest for ${{ steps.prepare_tags.outputs.image }} has been pushed successfully"

  # Release the Helm chart
  release:
    runs-on: ubuntu-latest
    needs: [build-cruisekube, build-cruisekube-frontend, read-chart-values]
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: "0"

      - name: Helm registry login
        run: |
          helm registry login -u ${{ env.HELM_REGISTRY_USERNAME}} -p ${{ env.HELM_REGISTRY_PASSWORD }} ${{ env.HELM_REGISTRY_URL }}

      - name: Helm push
        run: |
          cd charts
          CHART_DIR=cruisekube
          CHART_NAME=${{ needs.read-chart-values.outputs.chart_name }}
          CHART_VERSION=${{ needs.read-chart-values.outputs.chart_version }}
          # packaging chart
          helm dependency update $CHART_DIR
          helm package $CHART_DIR

          # pushing the helm charts
          echo "Pushing Chart: $CHART_NAME"
          echo "Version: $CHART_NAME-$CHART_VERSION.tgz"
          helm push $CHART_NAME-$CHART_VERSION.tgz oci://${{ env.HELM_CHART_REPOSITORY}}
          echo "Successfully pushed chart: $CHART_NAME"

      - name: Upload Helm chart to release
        uses: softprops/action-gh-release@v2
        with:
          files: "charts/${{ needs.read-chart-values.outputs.chart_name }}-${{ needs.read-chart-values.outputs.chart_version }}.tgz"
          tag_name: "${{ github.ref_name }}"
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}