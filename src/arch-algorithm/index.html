
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="CruiseKube is an intelligent Kubernetes resource optimization controller that automatically monitors, analyzes, and applies resource recommendations to improve cluster efficiency and reduce costs.">
      
      
        <meta name="author" content="TrueFoundry">
      
      
        <link rel="canonical" href="https://cruisekube.com/src/arch-algorithm/">
      
      
        <link rel="prev" href="../arch-overview/">
      
      
        <link rel="next" href="../dev-env/">
      
      
        
      
      
      <link rel="icon" href="../../images/logo/favicon/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Algorithm - CruiseKube</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  
  
  <!-- Additional SEO Meta Tags -->
  <meta name="robots" content="index, follow">
  <meta name="author" content="TrueFoundry">
  
  <!-- Dynamic Keywords from Page Meta -->
  
    <meta name="keywords" content="Kubernetes, Resource Optimization, Operator, Cloud Native, CruiseKube">
  
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="CruiseKube Documentation">
  <meta property="og:locale" content="en_US">
  
  <meta property="og:url" content="https://cruisekube.com/src/arch-algorithm/">
  
  <meta property="og:title" content="Algorithm - CruiseKube">
  <meta property="og:description" content="CruiseKube is an intelligent Kubernetes resource optimization controller that automatically monitors, analyzes, and applies resource recommendations to improve cluster efficiency and reduce costs.">
  <meta property="og:image" content="https://cruisekube.com/images/logo/logo_white_full.png">
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@truefoundry">
  <meta name="twitter:creator" content="@truefoundry">
  <meta name="twitter:title" content="Algorithm - CruiseKube">
  <meta name="twitter:description" content="CruiseKube is an intelligent Kubernetes resource optimization controller that automatically monitors, analyzes, and applies resource recommendations to improve cluster efficiency and reduce costs.">
  <meta name="twitter:image" content="https://cruisekube.com/images/logo/logo_white_full.png">
  
  <!-- Canonical URL -->
  
  <link rel="canonical" href="https://cruisekube.com/src/arch-algorithm/">
  
  
  <!-- Additional Meta Tags -->
  <meta name="theme-color" content="#1e293b">
  <meta name="msapplication-TileColor" content="#1e293b">
  <meta name="application-name" content="CruiseKube">
  <meta name="apple-mobile-web-app-title" content="CruiseKube">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  
    <!-- Organization Schema -->
    
    <script type="application/ld+json">
      {"@context": "https://schema.org", "@type": "Organization", "logo": "https://cruisekube.com/images/logo/cruiseKube_Colour.png", "name": "TrueFoundry", "sameAs": ["https://github.com/truefoundry", "https://discord.gg/Dqek4xJa3N"], "url": "https://truefoundry.com"}
    </script>
    
    
    <!-- Software Application Schema -->
    
    <script type="application/ld+json">
      {"@context": "https://schema.org", "@type": "SoftwareApplication", "applicationCategory": "DeveloperApplication", "author": {"@type": "Organization", "name": "TrueFoundry", "url": "https://truefoundry.com"}, "description": "CruiseKube is an intelligent Kubernetes resource optimization controller that automatically monitors, analyzes, and applies resource recommendations to improve cluster efficiency and reduce costs.", "downloadUrl": "https://github.com/truefoundry/CruiseKube", "keywords": ["Kubernetes", "Resource Optimization", "Operator", "Cloud Native"], "license": "https://github.com/truefoundry/cruiseKube/blob/main/LICENSE", "name": "CruiseKube", "operatingSystem": "Kubernetes", "programmingLanguage": "Go", "url": "https://cruisekube.com"}
    </script>
    
    
    <!-- Website Schema -->
    
    <script type="application/ld+json">
      {"@context": "https://schema.org", "@type": "WebSite", "description": "Official documentation for CruiseKube - Kubernetes resource optimization controller", "name": "CruiseKube Documentation", "potentialAction": {"@type": "SearchAction", "query-input": "required name=search_term_string", "target": "https://cruisekube.com/search/?q={search_term_string}"}, "publisher": {"@type": "Organization", "name": "TrueFoundry", "url": "https://truefoundry.com"}, "url": "https://cruisekube.com"}
    </script>
    
    
    <!-- Breadcrumb Schema -->
    
    <script type="application/ld+json">
      {"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "item": "https://cruisekube.com", "name": "Home", "position": 1}]}
    </script>
    
    
    <!-- Documentation Schema -->
    
    <script type="application/ld+json">
      {"@context": "https://schema.org", "@type": "TechArticle", "articleSection": "Documentation", "author": {"@type": "Organization", "name": "TrueFoundry", "url": "https://truefoundry.com"}, "dateModified": "2025-01-01", "datePublished": "2024-01-01", "description": "Comprehensive documentation for CruiseKube - Kubernetes resource optimization controller", "headline": "CruiseKube Documentation", "keywords": ["Kubernetes documentation", "Resource Optimization"], "mainEntityOfPage": {"@id": "https://cruisekube.com", "@type": "WebPage"}, "publisher": {"@type": "Organization", "logo": {"@type": "ImageObject", "url": "https://cruisekube.com/images/logo/cruiseKube_Colour.png"}, "name": "TrueFoundry", "url": "https://truefoundry.com"}}
    </script>
    
  

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
    <div style="text-align: center;"> 

    <a href="https://discord.gg/Dqek4xJa3N" style="color: #ffeb3b; text-decoration: none; font-weight: bold;" target="_blank" rel="noopener noreferrer">üí¨ Join Discord</a>
    <span style="margin-left: 20px; margin-right: 20px; font-weight: bold;"> - </span>
    <a href="https://github.com/truefoundry/cruiseKube" style="color: #ffeb3b; text-decoration: none; font-weight: bold;" target="_blank" rel="noopener noreferrer">‚≠ê Star on GitHub</a>
    
    </div>

          </div>
          
        </aside>
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="CruiseKube" class="md-header__button md-logo" aria-label="CruiseKube" data-md-component="logo">
      
  <img src="../../images/logo/cruiseKube_White.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CruiseKube
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Algorithm
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/truefoundry/CruiseKube" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    truefoundry/CruiseKube
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../gs-introduction/" class="md-tabs__link">
          
  
  
    
  
  Getting started

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../arch-overview/" class="md-tabs__link">
          
  
  
    
  
  Architecture

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../dev-env/" class="md-tabs__link">
          
  
  
    
  
  Development

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../blog/" class="md-tabs__link">
          
  
  
    
  
  Blog

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="CruiseKube" class="md-nav__button md-logo" aria-label="CruiseKube" data-md-component="logo">
      
  <img src="../../images/logo/cruiseKube_White.png" alt="logo">

    </a>
    CruiseKube
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/truefoundry/CruiseKube" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    truefoundry/CruiseKube
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gs-introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gs-installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Configuration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config-dashboard/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dashboard
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Architecture
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../arch-overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Algorithm
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Algorithm
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introduction
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problem-context" class="md-nav__link">
    <span class="md-ellipsis">
      
        Problem Context
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Problem Context">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#current-state-challenges" class="md-nav__link">
    <span class="md-ellipsis">
      
        Current State Challenges
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-changed" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Changed
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#design-philosophy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Design Philosophy
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Concepts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#psi-pressure-stall-indicator" class="md-nav__link">
    <span class="md-ellipsis">
      
        PSI (Pressure Stall Indicator)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#steady-state-vs-peak-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Steady State vs Peak Usage
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#algorithm-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Algorithm Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-1-admission-webhook-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 1: Admission Webhook Optimization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 1: Admission Webhook Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#when-it-runs" class="md-nav__link">
    <span class="md-ellipsis">
      
        When It Runs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Algorithm
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#purpose" class="md-nav__link">
    <span class="md-ellipsis">
      
        Purpose
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#phase-2-continuous-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Phase 2: Continuous Optimization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Phase 2: Continuous Optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#when-it-runs_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        When It Runs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#algorithm-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Algorithm Flow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detailed-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      
        Detailed Algorithm
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-differences-from-admission-webhook" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Differences from Admission Webhook
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-mechanisms" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Mechanisms
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Key Mechanisms">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#headroom-demand-distribution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Headroom Demand Distribution
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eviction-priority" class="md-nav__link">
    <span class="md-ellipsis">
      
        Eviction Priority
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-limit-calculation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory Limit Calculation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-cpu-limits-arent-needed" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why CPU Limits Aren't Needed
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#safety-reliability-related-mechanisms" class="md-nav__link">
    <span class="md-ellipsis">
      
        Safety &amp; Reliability Related Mechanisms
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Safety &amp; Reliability Related Mechanisms">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node-load-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        Node Load Monitoring
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preventing-repeated-evictions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Preventing Repeated Evictions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#high-priority-workload-protection" class="md-nav__link">
    <span class="md-ellipsis">
      
        High-Priority Workload Protection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#contention-mitigation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Contention Mitigation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      
        References
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Development
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Development
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dev-env/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dev Environment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dev-contributors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributors
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../blog/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Archive
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Archive
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/archive/2026/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2026
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Algorithm</h1>

<h2 id="introduction">Introduction</h2>
<p>Resource optimization in Kubernetes can be broken down into two fundamental problems:</p>
<ol>
<li><strong>Pod-level resource requests</strong>: Correctly specifying resource requests for each pod to match actual usage patterns</li>
<li><strong>Bin-packing</strong>: Efficiently scheduling multiple pods across nodes to maximize utilization</li>
</ol>
<p>While node auto-provisioners like Karpenter and Cluster Autoscaler address the second problem, they often produce suboptimal results due to reliability constraints like topology spread constraints, affinity rules, and pod disruption budgets. CruiseKube focuses exclusively on the first problem <strong>optimizing pod-level resource requests</strong> since this is where most resource wastage occurs (industry-wide CPU and memory utilization of provisioned resources is typically very low).</p>
<h2 id="problem-context">Problem Context</h2>
<h3 id="current-state-challenges">Current State Challenges</h3>
<p>The current approach to resource management in Kubernetes faces several fundamental challenges:</p>
<ul>
<li><strong>Reliability over cost</strong>: Engineers tend to over-provision resources to avoid reliability issues, prioritizing stability over efficiency</li>
<li><strong>Manual configuration</strong>: Resource requests must be set manually for each workload, and changes require updating workload definitions (Deployments, StatefulSets, DaemonSets). This adds friction and complexity to resource optimization process.</li>
<li><strong>Lopsided workload-level configuration</strong>: Pods running on different nodes for the same workload may have different resource requirements. This is particularly bad for DaemonSets where pods on different nodes may have vastly different resource needs - a pod on a large node might need 10x more resources than one on a smaller node, yet all pods share the same resource specification</li>
<li><strong>Peak provisioning</strong>: CPU usage can spike up to 1000x baseline for workloads with sparse requests or job-like characteristics. Provisioning for these peaks leads to massive cumulative over-provisioning across the cluster</li>
</ul>
<h3 id="what-changed">What Changed</h3>
<p>Two Kubernetes features enable a fundamentally different approach:</p>
<ol>
<li>
<p><strong><a href="https://kubernetes.io/blog/2025/05/16/kubernetes-v1-33-in-place-pod-resize-beta/">Kubernetes 1.33 - Pod-level resource updates</a>:</strong></p>
<ul>
<li>Resources can now be updated at the pod level without recreating pods</li>
<li>Each pod can be optimized independently based on its actual usage patterns</li>
<li>Shorter prediction horizons become viable since decisions can be updated near real-time as new data arrives</li>
<li>Pods can be optimized considering the current node's conditions, allowing resource sharing between pods on the same node without sacrificing reliability</li>
</ul>
</li>
<li>
<p><strong><a href="https://kubernetes.io/blog/2025/09/04/kubernetes-v1-34-introducing-psi-metrics-beta/">Kubernetes 1.34 - PSI (Pressure Stall Indicator) metrics</a>:</strong></p>
<ul>
<li>PSI metrics expose CPU and memory pressure at both node and container levels</li>
<li>CPU limits can be removed, replacing PSI metrics for CPU throttling signal for feedback on CPU contention</li>
<li>PSI-adjusted CPU usage provides accurate measurements of actual CPU demand under contention</li>
</ul>
</li>
</ol>
<h3 id="design-philosophy">Design Philosophy</h3>
<p>CruiseKube treats CPU and memory optimization differently:</p>
<ul>
<li>
<p><strong>CPU optimization</strong>: Most over-provisioning comes from CPU over-provisioning. Better CPU request specification leads to overall better resource utilization when combined with node auto-provisioners. CPU usage can be extremely spiky, but in case of CPU contention, the workload is throttled rather than failed.</p>
</li>
<li>
<p><strong>Memory optimization</strong>: Memory usage tends to be consistent once allocated. Once a container uses a certain amount of memory, it typically remains at that level. However, containers hitting memory limits are immediately killed via OOM (Out-of-Memory), making memory under-provisioning far more dangerous than CPU under-provisioning.</p>
</li>
</ul>
<h2 id="core-concepts">Core Concepts</h2>
<h3 id="psi-pressure-stall-indicator">PSI (Pressure Stall Indicator)</h3>
<p>PSI measures the time a task spends waiting for a resource (CPU, memory, or I/O). For CPU, PSI tracks how long processes wait for CPU time due to contention.</p>
<p><strong>PSI-Adjusted CPU Usage Formula:</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>PSI_adjusted_usage = cpu_usage √ó (1 + psi_waiting_rate)
</span></code></pre></div>
<p>Where:</p>
<ul>
<li><code>cpu_usage</code>: Raw CPU usage from <code>container_cpu_usage_seconds_total</code></li>
<li><code>psi_waiting_rate</code>: Rate of CPU waiting time from <code>container_pressure_cpu_waiting_seconds_total</code></li>
</ul>
<p><strong>Example:</strong>
If a container uses 0.5 CPU cores but experiences 20% CPU waiting time due to contention:
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>PSI_adjusted_usage = 0.5 √ó (1 + 0.2) = 0.6 CPU cores
</span></code></pre></div></p>
<p>This adjusted value reflects the actual CPU demand when the container is competing for resources, providing a more accurate basis for resource allocation decisions.</p>
<h3 id="steady-state-vs-peak-usage">Steady State vs Peak Usage</h3>
<p>CruiseKube distinguishes between two usage patterns:</p>
<ul>
<li><strong>Steady State (P75)</strong>: <ul>
<li><strong>CPU</strong>: The 75th percentile of CPU usage over the last 10 minutes. This represents the current and typical, sustained usage. Thhis serves as the baseline demand. </li>
<li><strong>Memory</strong>: The 75th percentile of memory usage over the last 30 minutes. The longer window accounts for memory's higher reliability requirements compared to CPU.</li>
</ul>
</li>
<li><strong>Peak Usage (Max)</strong>: The maximum value observed in the past 60 minutes at the current hour over the last 1 week. This methodology captures recurring patterns (e.g., daily cycles) while accounting for recent spikes. The difference between peak and steady state represents the <code>spike demand</code> or <code>headroom</code> needed to accommodate usage bursts.</li>
</ul>
<h2 id="algorithm-overview">Algorithm Overview</h2>
<p>CruiseKube uses a two-phase optimization approach:</p>
<ul>
<li>
<p><strong>Phase 1 (Admission Webhook)</strong>: Sets initial resource requests at scheduling time to ensure the pod is scheduled on a node with sufficient capacity.</p>
</li>
<li>
<p><strong>Phase 2 (Continuous Optimization)</strong>: Periodically optimizes running pods, redistributing resources based on actual node conditions and sharing max headroom across pods.</p>
</li>
</ul>
<h2 id="phase-1-admission-webhook-optimization">Phase 1: Admission Webhook Optimization</h2>
<p>The admission webhook intercepts pod creation requests and sets resource requests based on historical usage patterns.</p>
<h3 id="when-it-runs">When It Runs</h3>
<ul>
<li>Triggered during pod creation (before scheduling)</li>
<li>Mutates the pod specification before it reaches the scheduler</li>
</ul>
<h3 id="algorithm">Algorithm</h3>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">// Fetch historical statistics for this workload/container</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchWorkloadStats</span><span class="p">(</span><span class="n">pod</span><span class="p">.</span><span class="n">workloadIdentifier</span><span class="p">,</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1">// Max = max observed in past 60 minutes at current hour over last 1 week</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="n">cpuPeakDemand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stats</span><span class="p">.</span><span class="n">CPUStats</span><span class="p">.</span><span class="n">Max</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="n">memoryPeakDemand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stats</span><span class="p">.</span><span class="n">MemoryStats</span><span class="p">.</span><span class="n">Max</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="c1">// Set pod requests to accommodate peak usage</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="n">pod</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">containers</span><span class="p">[</span><span class="n">container</span><span class="p">].</span><span class="n">resources</span><span class="p">.</span><span class="n">requests</span><span class="p">.</span><span class="n">cpu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpuPeakDemand</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="n">pod</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">containers</span><span class="p">[</span><span class="n">container</span><span class="p">].</span><span class="n">resources</span><span class="p">.</span><span class="n">requests</span><span class="p">.</span><span class="n">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memoryPeakDemand</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="c1">// Set memory limit to 2 √ó max memory over last 7 days (safety buffer)</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="n">memoryLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">√ó</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">Memory7Day</span><span class="p">.</span><span class="n">Max</span><span class="p">)</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="n">pod</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">containers</span><span class="p">[</span><span class="n">container</span><span class="p">].</span><span class="n">resources</span><span class="p">.</span><span class="n">limits</span><span class="p">.</span><span class="n">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memoryLimit</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="c1">// Note: CPU limits are not set (relying on PSI metrics for feedback)</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="n">pod</span><span class="p">.</span><span class="n">Spec</span><span class="p">.</span><span class="n">containers</span><span class="p">[</span><span class="n">container</span><span class="p">].</span><span class="n">Resources</span><span class="p">.</span><span class="n">Limits</span><span class="p">.</span><span class="n">CPU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nil</span>
</span></code></pre></div>
<h3 id="purpose">Purpose</h3>
<ul>
<li><strong>Prevents repeated evictions</strong>: By setting requests to peak usage, the pod is guaranteed to fit on the node where it's scheduled even after continuous optimization has run.</li>
<li><strong>Provides initial optimization</strong>: Even without continuous optimization, pods start with better resource allocation</li>
</ul>
<h2 id="phase-2-continuous-optimization">Phase 2: Continuous Optimization</h2>
<p>The continuous optimization controller runs periodically, optimizing resources for pods already running on nodes.</p>
<h3 id="when-it-runs_1">When It Runs</h3>
<ul>
<li>Periodic reconciliation loop (configurable schedule)</li>
<li>Processes one node at a time</li>
<li>Updates pod resources in-place without pod recreation</li>
</ul>
<h3 id="algorithm-flow">Algorithm Flow</h3>
<pre class="mermaid"><code>flowchart TD
    A[Start: Process Node] --&gt; B[Identify Optimizable Pods]
    B --&gt; C[Calculate Base + Headroom Demand per Pod]
    C --&gt; D{Memory Fits?}
    D --&gt;|No| E[Evict Low Priority Pods&lt;br/&gt;Memory]
    D --&gt;|Yes| F{CPU Fits?}
    E --&gt; F
    F --&gt;|No| G[Evict Low Priority Pods&lt;br/&gt;CPU]
    F --&gt;|Yes| H[Calculate Max Headroom Demand]
    G --&gt; H
    H --&gt; I[Distribute Max Headroom&lt;br/&gt;Proportionally]
    I --&gt; J[Apply Resource Updates]
    J --&gt; K[Next Node]</code></pre>
<h3 id="detailed-algorithm">Detailed Algorithm</h3>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">FOR</span><span class="w"> </span><span class="n">EACH</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">cluster</span><span class="o">:</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">  </span><span class="c1">// Step 1: Identify scope of optimization</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">  </span><span class="n">optimizablePods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selectPodsEligibleForOptimization</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">pods</span><span class="p">)</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">  </span><span class="n">nonOptimizablePods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">pods</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">optimizablePods</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">  </span><span class="n">availableCPU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">allocatable</span><span class="p">.</span><span class="n">cpu</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">nonOptimizablePods</span><span class="p">.</span><span class="n">cpuRequests</span><span class="p">)</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">  </span><span class="n">availableMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">allocatable</span><span class="p">.</span><span class="n">memory</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">nonOptimizablePods</span><span class="p">.</span><span class="n">memoryRequests</span><span class="p">)</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">  </span><span class="c1">// Step 2: Compute baseline demand and headroom demand per pod</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">  </span><span class="n">FOR</span><span class="w"> </span><span class="n">EACH</span><span class="w"> </span><span class="n">pod</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">optimizablePods</span><span class="o">:</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">    </span><span class="n">FOR</span><span class="w"> </span><span class="n">EACH</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">pod</span><span class="p">.</span><span class="n">containers</span><span class="o">:</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">      </span><span class="c1">// CPU base demand: P75 over last 10 minutes</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">      </span><span class="n">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchWorkloadStats</span><span class="p">(</span><span class="n">pod</span><span class="p">.</span><span class="n">workloadIdentifier</span><span class="p">,</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">      </span><span class="n">container</span><span class="p">.</span><span class="n">CPUBaseDemand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stats</span><span class="p">.</span><span class="n">CPUStats</span><span class="p">.</span><span class="n">P75</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">      </span><span class="c1">// CPU headroom demand: Max - Base</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="w">      </span><span class="n">container</span><span class="p">.</span><span class="n">CPUHeadroomDemand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stats</span><span class="p">.</span><span class="n">CPUStats</span><span class="p">.</span><span class="n">Max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">CPUBaseDemand</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="w">      </span><span class="c1">// Memory base demand: P75 over last 30 minutes</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="w">      </span><span class="n">container</span><span class="p">.</span><span class="n">MemoryBaseDemand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stats</span><span class="p">.</span><span class="n">MemoryStats</span><span class="p">.</span><span class="n">P75</span><span class="w">  </span><span class="c1">// P75 over last 30 min</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="w">      </span><span class="c1">// Memory headroom demand: Max - Base</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="w">      </span><span class="n">container</span><span class="p">.</span><span class="n">MemoryHeadroomDemand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stats</span><span class="p">.</span><span class="n">MemoryStats</span><span class="p">.</span><span class="n">Max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">MemoryBaseDemand</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="w">    </span><span class="n">pod</span><span class="p">.</span><span class="n">evictionRanking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineEvictionRanking</span><span class="p">(</span><span class="n">pod</span><span class="p">)</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="w">    </span><span class="n">pod</span><span class="p">.</span><span class="n">totalRecommendedCPU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">CPUBaseDemand</span><span class="p">)</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="w">    </span><span class="n">pod</span><span class="p">.</span><span class="n">totalRecommendedMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">MemoryBaseDemand</span><span class="p">)</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a><span class="w">    </span><span class="n">pod</span><span class="p">.</span><span class="n">maxHeadroomCPU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">CPUHeadroomDemand</span><span class="p">)</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a><span class="w">    </span><span class="n">pod</span><span class="p">.</span><span class="n">maxHeadroomMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">MemoryHeadroomDemand</span><span class="p">)</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a><span class="w">  </span><span class="c1">// Step 3: Evict pods if memory doesn&#39;t fit</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="w">  </span><span class="n">sort</span><span class="w"> </span><span class="n">pods</span><span class="w"> </span><span class="n">by</span><span class="o">:</span><span class="w"> </span><span class="n">DaemonSet</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">evictionRanking</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxHeadroomMemory</span><span class="w"> </span><span class="p">(</span><span class="n">descending</span><span class="p">)</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a><span class="w">  </span><span class="n">WHILE</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">pod</span><span class="p">.</span><span class="n">totalRecommendedMemory</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">pod</span><span class="p">.</span><span class="n">maxHeadroomMemory</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">availableMemory</span><span class="o">:</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a><span class="w">    </span><span class="n">podToEvict</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pods</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w">  </span><span class="c1">// Lowest priority</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a><span class="w">    </span><span class="n">markForEviction</span><span class="p">(</span><span class="n">podToEvict</span><span class="p">)</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a><span class="w">    </span><span class="n">remove</span><span class="w"> </span><span class="n">podToEvict</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">pods</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a><span class="w">  </span><span class="c1">// Step 4: Evict pods if CPU doesn&#39;t fit</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a><span class="w">  </span><span class="n">sort</span><span class="w"> </span><span class="n">pods</span><span class="w"> </span><span class="n">by</span><span class="o">:</span><span class="w"> </span><span class="n">DaemonSet</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">evictionRanking</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxHeadroomCPU</span><span class="w"> </span><span class="p">(</span><span class="n">descending</span><span class="p">)</span>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a><span class="w">  </span><span class="n">WHILE</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">pod</span><span class="p">.</span><span class="n">totalRecommendedCPU</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">pod</span><span class="p">.</span><span class="n">maxHeadroomCPU</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">availableCPU</span><span class="o">:</span>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a><span class="w">    </span><span class="n">podToEvict</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pods</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w">  </span><span class="c1">// Lowest priority</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a><span class="w">    </span><span class="n">markForEviction</span><span class="p">(</span><span class="n">podToEvict</span><span class="p">)</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a><span class="w">    </span><span class="n">remove</span><span class="w"> </span><span class="n">podToEvict</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">pods</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a><span class="w">  </span><span class="c1">// Step 5: Distribute spike headroom across surviving pods</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a><span class="w">  </span><span class="n">maxHeadroomCPU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">pod</span><span class="p">.</span><span class="n">maxHeadroomCPU</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">pod</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">pods</span><span class="p">)</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a><span class="w">  </span><span class="n">maxHeadroomMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">pod</span><span class="p">.</span><span class="n">maxHeadroomMemory</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">pod</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">pods</span><span class="p">)</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a><span class="w">  </span><span class="n">totalHeadroomCPU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">CPUHeadroomDemand</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">pods</span><span class="p">)</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a><span class="w">  </span><span class="n">totalHeadroomMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">MemoryHeadroomDemand</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">containers</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">pods</span><span class="p">)</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a><span class="w">  </span><span class="n">FOR</span><span class="w"> </span><span class="n">EACH</span><span class="w"> </span><span class="n">pod</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">pods</span><span class="o">:</span>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a><span class="w">    </span><span class="n">FOR</span><span class="w"> </span><span class="n">EACH</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">pod</span><span class="p">.</span><span class="n">containers</span><span class="o">:</span>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a><span class="w">      </span><span class="c1">// Proportional distribution based on each container&#39;s spike demand</span>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a><span class="w">      </span><span class="n">cpuRatio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">CPUHeadroomDemand</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">totalHeadroomCPU</span>
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a><span class="w">      </span><span class="n">additionalCPU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxHeadroomCPU</span><span class="w"> </span><span class="err">√ó</span><span class="w"> </span><span class="n">cpuRatio</span>
</span><span id="__span-3-57"><a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>
</span><span id="__span-3-58"><a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a><span class="w">      </span><span class="n">memoryRatio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">MemoryHeadroomDemand</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">totalHeadroomMemory</span>
</span><span id="__span-3-59"><a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a><span class="w">      </span><span class="n">additionalMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxHeadroomMemory</span><span class="w"> </span><span class="err">√ó</span><span class="w"> </span><span class="n">memoryRatio</span>
</span><span id="__span-3-60"><a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a>
</span><span id="__span-3-61"><a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a><span class="w">      </span><span class="n">container</span><span class="p">.</span><span class="n">finalCPU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">CPUBaseDemand</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">additionalCPU</span>
</span><span id="__span-3-62"><a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a><span class="w">      </span><span class="n">container</span><span class="p">.</span><span class="n">finalMemory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">MemoryBaseDemand</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">additionalMemory</span>
</span><span id="__span-3-63"><a id="__codelineno-3-63" name="__codelineno-3-63" href="#__codelineno-3-63"></a>
</span><span id="__span-3-64"><a id="__codelineno-3-64" name="__codelineno-3-64" href="#__codelineno-3-64"></a><span class="w">  </span><span class="c1">// Step 6: Apply recommendations at runtime</span>
</span><span id="__span-3-65"><a id="__codelineno-3-65" name="__codelineno-3-65" href="#__codelineno-3-65"></a><span class="w">  </span><span class="n">FOR</span><span class="w"> </span><span class="n">EACH</span><span class="w"> </span><span class="n">pod</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">pods</span><span class="o">:</span>
</span><span id="__span-3-66"><a id="__codelineno-3-66" name="__codelineno-3-66" href="#__codelineno-3-66"></a><span class="w">    </span><span class="n">FOR</span><span class="w"> </span><span class="n">EACH</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">pod</span><span class="p">.</span><span class="n">containers</span><span class="o">:</span>
</span><span id="__span-3-67"><a id="__codelineno-3-67" name="__codelineno-3-67" href="#__codelineno-3-67"></a><span class="w">      </span><span class="c1">// Apply CPU request (no CPU limit set)</span>
</span><span id="__span-3-68"><a id="__codelineno-3-68" name="__codelineno-3-68" href="#__codelineno-3-68"></a><span class="w">      </span><span class="n">applyCPURequest</span><span class="p">(</span><span class="n">pod</span><span class="p">,</span><span class="w"> </span><span class="n">container</span><span class="p">,</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">finalCPU</span><span class="p">)</span>
</span><span id="__span-3-69"><a id="__codelineno-3-69" name="__codelineno-3-69" href="#__codelineno-3-69"></a>
</span><span id="__span-3-70"><a id="__codelineno-3-70" name="__codelineno-3-70" href="#__codelineno-3-70"></a><span class="w">      </span><span class="c1">// Apply memory request and limit</span>
</span><span id="__span-3-71"><a id="__codelineno-3-71" name="__codelineno-3-71" href="#__codelineno-3-71"></a><span class="w">      </span><span class="c1">// Limit = 2 √ó max(memory over last 7 days, OOM memory)</span>
</span><span id="__span-3-72"><a id="__codelineno-3-72" name="__codelineno-3-72" href="#__codelineno-3-72"></a><span class="w">      </span><span class="n">memoryLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">√ó</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">Memory7Day</span><span class="p">.</span><span class="n">Max</span><span class="p">)</span>
</span><span id="__span-3-73"><a id="__codelineno-3-73" name="__codelineno-3-73" href="#__codelineno-3-73"></a><span class="w">      </span><span class="n">applyMemoryRequestAndLimit</span><span class="p">(</span><span class="n">pod</span><span class="p">,</span><span class="w"> </span><span class="n">container</span><span class="p">,</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="n">finalMemory</span><span class="p">,</span><span class="w"> </span><span class="n">memoryLimit</span><span class="p">)</span>
</span><span id="__span-3-74"><a id="__codelineno-3-74" name="__codelineno-3-74" href="#__codelineno-3-74"></a>
</span><span id="__span-3-75"><a id="__codelineno-3-75" name="__codelineno-3-75" href="#__codelineno-3-75"></a><span class="n">END</span>
</span></code></pre></div>
<h3 id="key-differences-from-admission-webhook">Key Differences from Admission Webhook</h3>
<ul>
<li><strong>Resource sharing</strong>: Headroom is distributed proportionally rather than allocated fully to each pod</li>
<li><strong>Node-aware</strong>: Considers actual node capacity and current pod placement</li>
<li><strong>Eviction support</strong>: Can evict pods to make room for better optimization</li>
<li><strong>Incremental updates</strong>: Resources are updated in-place without pod recreation</li>
</ul>
<h2 id="key-mechanisms">Key Mechanisms</h2>
<h3 id="headroom-demand-distribution">Headroom Demand Distribution</h3>
<p>Rather than provisioning each pod for its maximum spike, CruiseKube distributes spike headroom across pods on a node. This is done with the following rationale:</p>
<ol>
<li>Not all pods on a node spike simultaneously</li>
<li>The maximum headroom demand across all pods on a node represents the short lived and worst-case scenario for the node</li>
</ol>
<p>This <code>headroom</code> (i.e. peak usage - steady state) is shared proportionally, reducing total resource requirements for the node</p>
<h3 id="eviction-priority">Eviction Priority</h3>
<p>When a node cannot accommodate all pods, CruiseKube uses a priority-based eviction system to make space:</p>
<ol>
<li><strong>DaemonSets</strong>: Always protected from eviction (they must run on every node)</li>
<li><strong>Eviction Ranking</strong>: Configurable per-workload priority that determines eviction order:<ul>
<li><strong>Low</strong>: Low priority workloads are evicted first. This is the priority for most workloads by default</li>
<li><strong>Medium</strong>: Medium priority workloads are evicted next. Single replica or statefulset workloads are set to this value by default</li>
<li><strong>High</strong>: High priority workloads are evicted as a last resort</li>
<li><strong>No-Eviction</strong>: No-eviction workloads are never evicted at all</li>
</ul>
</li>
<li><strong>Tie-breaker</strong>: Among pods with the same eviction ranking, those with higher headroom demand (<code>peak_usage - base_demand</code>) are evicted first, to minimise the number of evictions needed</li>
</ol>
<h3 id="memory-limit-calculation">Memory Limit Calculation</h3>
<p>Memory limits are set independently from memory requests to provide a safety buffer:</p>
<ul>
<li><strong>Memory Limit Formula</strong>: <code>2 √ó (maxMemoryUsage7Days, limitMemoryAtOOMKill)</code></li>
<li><code>maxMemoryUsage7Days</code>: Maximum memory usage observed over the last 7 days</li>
<li><code>limitMemoryAtOOMKill</code>: Memory limit at the time of OOM kill events (if any)</li>
<li><strong>Purpose</strong>: Prevents OOM kills by providing headroom above the optimized request value</li>
<li><strong>Rationale</strong>: Memory requests can be optimized aggressively (down to P75 + distributed spike), while limits ensure containers have sufficient headroom to handle unexpected memory growth</li>
</ul>
<h3 id="why-cpu-limits-arent-needed">Why CPU Limits Aren't Needed</h3>
<p>CruiseKube does not set CPU limits, only CPU requests. This differs from memory, where both requests and limits are configured.</p>
<p><strong>Traditional CPU limits serve two purposes</strong>:</p>
<ol>
<li><strong>Resource isolation</strong>: Prevent one pod from consuming all CPU</li>
<li><strong>Throttling feedback</strong>: Indicate when a pod needs more CPU</li>
</ol>
<p><strong>With PSI metrics</strong>:</p>
<ul>
<li><strong>PSI provides throttling feedback</strong>: High PSI values indicate CPU contention without needing limits</li>
<li><strong>Requests provide isolation</strong>: CPU requests ensure fair scheduling and resource allocation</li>
<li><strong>Better observability</strong>: PSI metrics provide more granular insight into contention than throttling metrics</li>
</ul>
<p><strong>Contrast with Memory</strong>:</p>
<p>By removing CPU limits and using PSI-adjusted usage for requests, CruiseKube:</p>
<ul>
<li>Eliminates unnecessary CPU throttling</li>
<li>Provides more accurate CPU resource allocation</li>
<li>Maintains reliability through PSI-based feedback</li>
<li>Allows CPU to burst when available, improving overall utilization</li>
</ul>
<h2 id="safety-reliability-related-mechanisms">Safety &amp; Reliability Related Mechanisms</h2>
<h3 id="node-load-monitoring">Node Load Monitoring</h3>
<p>To mitigate scenarios where multiple pods spike simultaneously, CruiseKube monitors node load:</p>
<ul>
<li><strong>Load Calculation</strong>: <code>node_load1 / node_cpu_capacity</code></li>
<li><strong>Threshold</strong>: When load exceeds 100% (1.0), the node is considered overloaded</li>
<li><strong>Action</strong>: Node is cordoned (tainted with <code>NoSchedule</code>) to prevent new pod scheduling</li>
<li><strong>Recovery</strong>: Taint is removed when load drops below threshold</li>
</ul>
<p>During overload:</p>
<ul>
<li>PSI metrics increase, causing future resource requests to be higher</li>
<li>No new pods are scheduled on the overloaded node to prevent further resource contention</li>
</ul>
<h3 id="preventing-repeated-evictions">Preventing Repeated Evictions</h3>
<p>The admission webhook ensures pods are scheduled with requests equal to their peak usage. This guarantees:</p>
<ul>
<li>The node has sufficient capacity at scheduling time</li>
<li>Subsequent continuous optimization runs only evict pods whose spikes cannot be accommodated</li>
<li>Once evicted, a pod will be rescheduled with peak requests, preventing immediate re-eviction</li>
</ul>
<h3 id="high-priority-workload-protection">High-Priority Workload Protection</h3>
<ul>
<li>Single-replica workloads and StatefulSets default to medium eviction ranking</li>
<li>Most workloads default to low eviction ranking</li>
<li>Users can configure eviction ranking per workload via overrides</li>
<li>DaemonSets are never evicted</li>
<li>Workloads with no-eviction ranking are never evicted</li>
</ul>
<h3 id="contention-mitigation">Contention Mitigation</h3>
<ul>
<li><strong>Node cordoning</strong>: Overloaded nodes are isolated to prevent further scheduling</li>
<li><strong>PSI feedback</strong>: High PSI values increase resource requests for future optimizations</li>
<li><strong>Proportional distribution</strong>: Headroom is shared, reducing the likelihood of simultaneous spikes exhausting resources</li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><a href="https://kubernetes.io/blog/2025/05/16/kubernetes-v1-33-in-place-pod-resize-beta/">Kubernetes 1.33 - Pod-level resource updates</a></li>
<li><a href="https://kubernetes.io/blog/2025/09/04/kubernetes-v1-34-introducing-psi-metrics-beta/">Kubernetes 1.34 - PSI (Pressure Stall Indicator) metrics</a></li>
<li><a href="https://facebookmicrosites.github.io/psi/">PSI Documentation</a></li>
</ul>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../arch-overview/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Overview">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Overview
              </div>
            </div>
          </a>
        
        
          
          <a href="../dev-env/" class="md-footer__link md-footer__link--next" aria-label="Next: Dev Environment">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Dev Environment
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 TrueFoundry
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://discord.gg/Dqek4xJa3N" target="_blank" rel="noopener" title="discord.gg" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1.1s-.6.4-.8.8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2C162.5 39 122.2 51.5 84.1 69c-.3.1-.6.4-.8.7C7.1 183.5-13.8 294.6-3.6 404.2c0 .3.1.5.2.8s.3.4.5.6c44.4 32.9 94 58 146.8 74.2.4.1.8.1 1.1 0s.7-.4.9-.7c11.3-15.4 21.4-31.8 30-48.8.1-.2.2-.5.2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6.2-.9.3-.5.6-.7c3.1-2.3 6.2-4.7 9.1-7.1.3-.2.6-.4.9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1.7-.2 1-.2s.7.2.9.4c2.9 2.4 6 4.9 9.1 7.2.2.2.4.4.6.7s.2.6.2.9-.1.6-.3.9-.4.5-.6.6c-14.7 8.6-30 15.9-45.9 21.8-.2.1-.5.2-.7.4s-.3.4-.4.7-.1.5-.1.8.1.5.2.8c8.8 17 18.8 33.3 30 48.8.2.3.6.6.9.7s.8.1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2.2-.2.4-.4.5-.6s.2-.5.2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2m195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/truefoundry" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://x.com/truefoundry" target="_blank" rel="noopener" title="x.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M357.2 48h70.6L273.6 224.2 455 464H313L201.7 318.6 74.5 464H3.8l164.9-188.5L-5.2 48h145.6l100.5 132.9zm-24.8 373.8h39.1L119.1 88h-42z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.code.annotate", "content.code.copy", "content.tabs.link", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>